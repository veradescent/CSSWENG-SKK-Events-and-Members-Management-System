<head>
  <script defer src="/js/adminHomePage.js"></script>
  <link rel="stylesheet" href="/css/adminHomePage.css">
</head>

<div class="container mt-5">
  <div class="text-center">
    <h1 class="fw-bold display-3">Simpleng Kristiyanong Komunidad</h1>
  </div>
  <div class="homepage-slideshow" id="homepageSlideshow" aria-label="Homepage slideshow">
    <div class="slides" aria-live="polite">
      <!-- Slides: each .slide covers the full area; images use object-fit:cover and opacity 0.7 -->
      <div class="slide"><img src="/assets/SKK_1.jpg" alt="Slideshow Image 1" class="slide-image"></div>
      <div class="slide"><img src="/assets/SKK_2.jpg" alt="Slideshow Image 2" class="slide-image"></div>
    </div>
  </div>

  <!-- upcoming events (carousel) -->
  <section id="events-carousel-section" class="mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h4 class="m-0">Upcoming Events</h4>
    </div>

    <div class="events-carousel-container" style="position:relative;">
      <div id="eventsCarousel" class="events-carousel-wrapper">
        {{#if upcoming}}
          {{#each upcoming}}
          <div class="event-card-wrapper">
            <div class="card mt-3">
              <div class="card-body d-flex">
                <div style="flex:1 1 auto; min-width:0;">
                  <h6 class="card-subtitle mb-2 text-muted">
                    {{displayDate}} | {{displayStartTime}} - {{displayEndTime}}
                  </h6>
                  <h5 class="card-title">{{eventName}}</h5>
                  <p>{{eventDescription}}</p>

                  {{#if ../user}}
                    {{#if (eq ../user.role 'admin')}}
                      <div class="d-flex justify-content-end">
                        <a class="btn btn-primary btn-sm" href="/editEvent/{{_id}}">Edit</a>
                      </div>
                    {{/if}}
                  {{/if}}
                </div>

                <div class="event-thumb" style="margin-left:12px;">
                  <img src="{{#if image}}{{image}}{{else}}/assets/SKK_Logo.png{{/if}}" 
                       alt="{{eventName}}" 
                       class="event-thumb-img">
                </div>
              </div>
            </div>
          </div>
          {{/each}}
        {{else}}
          <div class="no-upcoming">No upcoming events.</div>
        {{/if}}
      </div>
      <div class="carousel-controls mt-2 text-center">
        <button id="carouselLeft" class="carousel-arrow carousel-arrow-left" aria-label="previous" type="button">&larr;</button>
        <button id="carouselRight" class="carousel-arrow carousel-arrow-right" aria-label="next" type="button">&rarr;</button>
      </div>
    </div>
  </section>

  {{#if user}}
    {{#if (eq user.role 'admin')}}

      <!-- PREVIOUS EVENTS (server-rendered) -->
      <section id="previous-events-section" class="mt-5">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h4 class="m-0">Previous Events</h4>
        </div>

        <div class="events-carousel-container" style="position:relative;">
          <!-- container that the client script fills -->
          <div id="previousEventsList" class="events-carousel-wrapper">
            {{#if previous}}
              {{#each previous}}
                <div class="event-card-wrapper">
                  <div class="card mt-3">
                    <div class="card-body d-flex">
                      <div style="flex:1 1 auto; min-width:0;">
                        <h6 class="card-subtitle mb-2 text-muted">
                          {{displayDate}} | {{displayStartTime}} - {{displayEndTime}}
                        </h6>
                        <h5 class="card-title">{{eventName}}</h5>
                        <div class="d-flex justify-content-end">
                          <a class="btn btn-primary btn-sm" href="/editEvent/{{_id}}">Edit</a>
                        </div>
                      </div>

                      <div class="event-thumb" style="margin-left:12px;">
                        <img src="{{#if image}}{{image}}{{else}}/assets/SKK_Logo.png{{/if}}"
                             alt="{{eventName}}"
                             class="event-thumb-img">
                      </div>
                    </div>
                  </div>
                </div>
              {{/each}}
            {{else}}
              <p class="text-muted">No previous events available.</p>
            {{/if}}
          </div>
        </div>
      </section>

    {{/if}}
  {{/if}}

  {{#if user}}
    {{#if (eq user.role 'admin')}}
      <div class="justify-content-end">
        <button class="mt-3 btn btn-success rounded" id="create-event" type="button">
          Create a New Event
        </button>
      </div>
    {{/if}}
  {{/if}}

</div>

<!-- helpful hidden element for the client to detect role reliably -->
<div id="templateMeta" data-role="{{#if user}}{{user.role}}{{else}}guest{{/if}}" style="display:none;"></div>

<!-- client script: loads ALL past events and renders into #previousEventsList -->
<script>
(async function loadAllPreviousEvents(){
  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  const container = document.getElementById('previousEventsList');
  // if section not on page (non-admin), exit silently
  if (!container) return;

  try {
    const resp = await fetch('/api/reports/previous-all', { credentials: 'same-origin' });
    if (!resp.ok) {
      const text = await resp.text().catch(()=>null);
      console.error('Failed to fetch previous-all:', resp.status, text);
      container.innerHTML = '<p class="text-muted">Failed to load previous events.</p>';
      return;
    }
    const data = await resp.json();
    if (!data.success || !Array.isArray(data.events) || data.events.length === 0) {
      container.innerHTML = '<p class="text-muted">No previous events available.</p>';
      return;
    }

    const role = (document.getElementById('templateMeta')?.dataset?.role) || 'guest';
    const isAdmin = String(role).toLowerCase() === 'admin';

    const html = data.events.map(ev => {
      const img = ev.image || '/assets/SKK_Logo.png';
      const editBtn = isAdmin ? `<div class="d-flex justify-content-end"><a class="btn btn-primary btn-sm" href="/editEvent/${ev._id}">Edit</a></div>` : '';
      const minutesLinkHtml = ev.minutesLink ? `<div style="margin-top:6px;"><a href="${escapeHtml(ev.minutesLink)}" target="_blank" rel="noopener noreferrer">Minutes of the Meeting</a></div>` : '';
      return `
        <div class="event-card-wrapper">
          <div class="card mt-3">
            <div class="card-body d-flex">
              <div style="flex:1 1 auto; min-width:0;">
                <h6 class="card-subtitle mb-2 text-muted">
                  ${escapeHtml(ev.displayDate || '')} | ${escapeHtml(ev.displayStartTime || '')} - ${escapeHtml(ev.displayEndTime || '')}
                </h6>
                <h5 class="card-title">${escapeHtml(ev.eventName || ev.title || '')}</h5>
                ${minutesLinkHtml}
                ${editBtn}
              </div>
              <div class="event-thumb" style="margin-left:12px;">
                <img src="${escapeHtml(img)}" alt="${escapeHtml(ev.eventName || ev.title || '')}" class="event-thumb-img">
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;

  } catch (err) {
    console.error('Error loading previous events:', err);
    container.innerHTML = '<p class="text-muted">Error loading previous events.</p>';
  }
})();
</script>
