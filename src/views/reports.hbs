<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SKK Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: "Poppins", sans-serif;
      margin: 0;
    }

    .page-title {
      text-align: center;
      font-weight: 700;
      font-size: 2rem;
      margin: 30px 0;
    }

    .reports-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      max-width: 1100px;
      margin: auto;
      padding: 0 20px;
    }

    /* Calendar */
    .calendar-box {
      background-color: #f6f6f6;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-header h4 {
      margin: 0;
      font-weight: 600;
    }
    .calendar-controls button {
      background-color: #133b1c;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 12px;
      margin: 0 3px;
      font-size: 0.9rem;
    }
    .calendar-controls .active {
      background-color: #5dbb63;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
    }

    .day-header {
      font-weight: 600;
      padding: 10px 0;
      background-color: #5dbb63;
      color: white;
      border-radius: 5px;
      text-align: center;
    }

    .calendar-day {
      background-color: #dcdcdc;
      padding: 15px;
      border-radius: 6px;
      min-height: 80px;
      font-size: 0.9rem;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-box.day-view .calendar-day {
      min-height: 150px; 
      font-size: 1.1rem;
    }

    .calendar-day.event {
      background-color: #b4e4b4;
      border: 1px solid #3a813a;
      color: #133b1c;
      font-weight: 500;
    }

    .previous-events {
      background-color: #f0f0f0;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .event-card {
      background-color: white;
      border-left: 4px solid #5dbb63;
      border-radius: 6px;
      padding: 10px 15px;
      margin-bottom: 10px;
    }

    .view-btn {
      display: block;
      background-color: #5dbb63;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      padding: 10px 30px;
      margin: 30px auto;
    }

    .chart-container {
      max-width: 800px;
      background-color: #fafafa;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 0 auto 60px;
    }
  </style>
</head>

<body>
  <h2 class="page-title">SKK Reports</h2>

  <div class="reports-container">
    <!-- Calendar -->
    <div class="calendar-box" id="calendarBox">
    <div class="calendar-header">
      <div style="display:flex; gap:12px; align-items:center;">
        <button id="prevMonthBtn" title="Previous month" class="px-3 py-1 rounded border">‹</button>
        <h4 id="calendarTitle" style="margin:0 8px;">October 2025</h4>
        <button id="nextMonthBtn" title="Next month" class="px-3 py-1 rounded border">›</button>
      </div>

      <div class="calendar-controls">
        <button id="dayBtn">Day</button>
        <button id="weekBtn">Week</button>
        <button id="monthBtn" class="active">Month</button>
      </div>
    </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Headers -->
        <div class="day-header">SUN</div>
        <div class="day-header">MON</div>
        <div class="day-header">TUE</div>
        <div class="day-header">WED</div>
        <div class="day-header">THU</div>
        <div class="day-header">FRI</div>
        <div class="day-header">SAT</div>
      </div>
    </div>

    <!-- Previous Events -->
    <div class="previous-events">
      <h5>Previous events</h5>
      <div class="event-card">
        <small>October 15, 2025 | 9:00 AM – 2:00 PM</small>
        <strong>SKK General Assembly</strong>
        <small>LOCATION: Quezon City</small>
      </div>
      <div class="event-card">
        <small>October 19, 2025 | 1:00 PM – 3:00 PM</small>
        <strong>Church Event</strong>
        <small>LOCATION: Quezon City</small>
      </div>
    </div>
  </div>

  <button class="view-btn">View Statistics</button>

  <div class="chart-container">
    <canvas id="eventChart"></canvas>
    <p class="text-center mt-3 mb-0 fw-semibold">Total attendees: 400</p>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (async function(){
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevBtn = document.getElementById('prevMonthBtn');
    const nextBtn = document.getElementById('nextMonthBtn');
    const dayBtn = document.getElementById('dayBtn');
    const weekBtn = document.getElementById('weekBtn');
    const monthBtn = document.getElementById('monthBtn');
    const calendarBox = document.getElementById('calendarBox');

    const previewModal = document.getElementById('dayPreviewModal') || null;
    const previewList = document.getElementById('previewList') || null;
    const previewDate = document.getElementById('previewDate') || null;
    const closePreviewBtn = document.getElementById('closePreviewBtn') || null;

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    let currentDate = new Date(); // active date context
    let currentView = 'month'; // 'month' | 'week' | 'day'
    let eventsCache = [];

    function weekdayHeadersHtml() {
      return `
        <div class="day-header">SUN</div>
        <div class="day-header">MON</div>
        <div class="day-header">TUE</div>
        <div class="day-header">WED</div>
        <div class="day-header">THU</div>
        <div class="day-header">FRI</div>
        <div class="day-header">SAT</div>
      `;
    }

    async function fetchEventsForRange(startISO, endISO) {
      try {
        const res = await fetch(`/api/events?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}`);
        const data = await res.json();
        if (!data.success) return [];
        return data.events.map(ev => {
          const startStr = ev.start || ev.startUTC || ev.startDateTime || ev.date;
          return { ...ev, startDate: startStr ? new Date(startStr) : null };
        });
      } catch (err) {
        console.error('Error fetching events', err);
        return [];
      }
    }

    // MARK: Renderers
    function renderMonthView(date) {
      const y = date.getFullYear(), m = date.getMonth();
      calendarTitle.textContent = `${monthNames[m]} ${y}`;
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const firstWeekday = new Date(y, m, 1).getDay();

      let html = weekdayHeadersHtml();

      // leading blanks
      for (let i=0;i<firstWeekday;i++) html += `<div class="calendar-day empty" aria-hidden="true"></div>`;
      // days
      for (let d=1; d<=daysInMonth; d++) {
        html += `<div class="calendar-day" data-day="${d}" data-month="${m}" data-year="${y}">${d}</div>`;
      }
      // trailing blanks
      const total = firstWeekday + daysInMonth;
      const trailing = (7 - (total % 7)) % 7;
      for (let i=0;i<trailing;i++) html += `<div class="calendar-day empty" aria-hidden="true"></div>`;

      calendarGrid.innerHTML = html;
      highlightTodayIfNeeded(y,m);
      markEventDays();
      attachDayClickHandlers();
    }

    function renderWeekView(date) {
      // Find start of week (Sunday)
      const copy = new Date(date);
      const startOfWeek = new Date(copy.setDate(copy.getDate() - copy.getDay()));
      calendarTitle.textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}, ${startOfWeek.getFullYear()}`;

      let html = weekdayHeadersHtml();
      // render 7 day cells showing actual dates
      for (let i=0;i<7;i++) {
        const d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        html += `<div class="calendar-day" data-day="${d.getDate()}" data-month="${d.getMonth()}" data-year="${d.getFullYear()}">${d.getDate()}</div>`;
      }

      calendarGrid.innerHTML = html;
      highlightTodayIfNeeded(startOfWeek.getFullYear(), startOfWeek.getMonth());
      markEventDays();
      attachDayClickHandlers();
    }

    function renderDayView(date) {
      calendarTitle.textContent = `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
      // Day view: show header row and one large day cell spanning grid columns (we'll still keep grid)
      let html = weekdayHeadersHtml();
      html += `<div class="calendar-day" style="grid-column: 1 / -1; min-height: 160px;" data-day="${date.getDate()}" data-month="${date.getMonth()}" data-year="${date.getFullYear()}">${date.getDate()}</div>`;
      calendarGrid.innerHTML = html;
      highlightTodayIfNeeded(date.getFullYear(), date.getMonth());
      markEventDays();
      attachDayClickHandlers();
    }

    function highlightTodayIfNeeded(y, m) {
      const today = new Date();
      calendarGrid.querySelectorAll('.calendar-day').forEach(el=>el.classList.remove('today'));
      if (today.getFullYear() === y && today.getMonth() === m) {
        const sel = `.calendar-day[data-day="${today.getDate()}"][data-month="${today.getMonth()}"][data-year="${today.getFullYear()}"]`;
        const todayCell = calendarGrid.querySelector(sel);
        if (todayCell) todayCell.classList.add('today');
      }
    }

    // mark event days using eventsCache
    function markEventDays() {
      const dayMap = new Map();
      for (const ev of eventsCache) {
        if (!ev.startDate) continue;
        const key = `${ev.startDate.getFullYear()}-${ev.startDate.getMonth()}-${ev.startDate.getDate()}`;
        if (!dayMap.has(key)) dayMap.set(key, []);
        dayMap.get(key).push(ev);
      }
      calendarGrid.querySelectorAll('.calendar-day').forEach(cell => {
        if (cell.classList.contains('empty')) return;
        const y = Number(cell.dataset.year), m = Number(cell.dataset.month), d = Number(cell.dataset.day);
        const key = `${y}-${m}-${d}`;
        const evs = dayMap.get(key) || [];
        if (evs.length) {
          cell.classList.add('has-event');
          cell.dataset.events = JSON.stringify(evs.map(e => ({ id: e.id, title: e.title, time: e.startDate ? e.startDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '' })));
        } else {
          cell.classList.remove('has-event');
          cell.dataset.events = '';
        }
      });
    }

    function attachDayClickHandlers() {
      calendarGrid.querySelectorAll('.calendar-day').forEach(cell=>{
        if (cell.classList.contains('empty')) return;
        cell.onclick = () => {
          const evs = cell.dataset.events ? JSON.parse(cell.dataset.events) : [];
          showPreview(cell, evs);
        };
      });
    }

    function showPreview(cell, evs) {
      if (!previewModal || !previewList || !previewDate) {
        // fallback
        if (!evs || evs.length === 0) return alert('No events for this day.');
        return alert(evs.map(e=>`${e.time} ${e.title}`).join('\n'));
      }
      const y = cell.dataset.year, m = Number(cell.dataset.month), d = cell.dataset.day;
      previewDate.textContent = `${monthNames[m]} ${d}, ${y}`;
      previewList.innerHTML = '';
      if (!evs || evs.length === 0) previewList.innerHTML = `<p class="text-muted">No events for this day.</p>`;
      else {
        evs.forEach(e => {
          const el = document.createElement('div');
          el.className = 'event-card';
          el.innerHTML = `<div><small>${e.time}</small></div><div style="font-weight:600">${e.title}</div>`;
          previewList.appendChild(el);
        });
      }
      previewModal.classList.remove('hidden');
    }

    if (closePreviewBtn) {
      closePreviewBtn.onclick = () => previewModal.classList.add('hidden');
      previewModal.addEventListener('click', (ev) => { if (ev.target === previewModal) previewModal.classList.add('hidden'); });
    }

    // Navigation behavior changes depending on currentView
    prevBtn && (prevBtn.onclick = async () => {
      if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() - 1);
      else if (currentView === 'week') currentDate.setDate(currentDate.getDate() - 7);
      else currentDate.setDate(currentDate.getDate() - 1);
      await loadForCurrentView();
    });
    nextBtn && (nextBtn.onclick = async () => {
      if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + 1);
      else if (currentView === 'week') currentDate.setDate(currentDate.getDate() + 7);
      else currentDate.setDate(currentDate.getDate() + 1);
      await loadForCurrentView();
    });

    function setActiveView(view) {
      currentView = view;
      document.querySelectorAll('.calendar-controls button').forEach(b => b.classList.remove('active'));
      if (view === 'month') monthBtn.classList.add('active');
      if (view === 'week') weekBtn.classList.add('active');
      if (view === 'day') dayBtn.classList.add('active');
    }

    // wire view toggle buttons
    dayBtn && (dayBtn.onclick = async () => { setActiveView('day'); await loadForCurrentView(); calendarBox.classList.add('day-view'); });
    weekBtn && (weekBtn.onclick = async () => { setActiveView('week'); await loadForCurrentView(); calendarBox.classList.remove('day-view'); });
    monthBtn && (monthBtn.onclick = async () => { setActiveView('month'); await loadForCurrentView(); calendarBox.classList.remove('day-view'); });

    // load events for the relevant range depending on view
    async function loadForCurrentView() {
      if (currentView === 'month') {
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const start = `${y}-${String(m+1).padStart(2,'0')}-01`;
        const last = new Date(y, m+1, 0).getDate();
        const end = `${y}-${String(m+1).padStart(2,'0')}-${String(last).padStart(2,'0')}`;
        eventsCache = await fetchEventsForRange(start, end);
        renderMonthView(currentDate);
      } else if (currentView === 'week') {
        // fetch month-range large enough to cover week (simple: fetch 1 week window)
        const copy = new Date(currentDate);
        const startOfWeek = new Date(copy.setDate(copy.getDate() - copy.getDay()));
        const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6);
        eventsCache = await fetchEventsForRange(startOfWeek.toISOString().slice(0,10), endOfWeek.toISOString().slice(0,10));
        renderWeekView(currentDate);
      } else { // day
        const d = currentDate;
        const iso = d.toISOString().slice(0,10);
        eventsCache = await fetchEventsForRange(iso, iso);
        renderDayView(currentDate);
      }
    }

    // initial
    setActiveView('month');
    await loadForCurrentView();

    // expose refresh
    window.refreshReportsCalendar = async () => { await loadForCurrentView(); };

  })();
}); // DOMContentLoaded
</script>



<!-- Event Preview Modal -->
<div id="dayPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-4 max-w-lg w-full mx-4 shadow-lg">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <h3 id="previewDate" class="text-lg font-semibold">Date</h3>
      <button id="closePreviewBtn" class="text-gray-600">Close</button>
    </div>
    <div id="previewList">
      <!-- events will be injected here -->
    </div>
  </div>
</div>

<style>
  /* day with events */
  .calendar-day.has-event {
    background: #b4e4b4;
    border: 1px solid #3a813a;
    color: #133b1c;
    font-weight: 600;
    cursor: pointer;
  }
  .calendar-day.empty {
    background: transparent;
    box-shadow: none;
  }
  .calendar-day.today {
    box-shadow: 0 0 0 2px rgba(93,187,99,0.25) inset;
  }
  /* modal utility */
  .hidden { display: none; }
</style>

</body>
</html>
